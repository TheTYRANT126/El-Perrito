<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>El Perrito — Editar Usuario</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/admin-dashboard.css">
</head>

<body class="bg">
    <header class="header">
        <a href="index.html"><img class="logo" src="images/logo.png" alt="El Perrito"></a>
        <nav class="nav">
            <a href="admin-dashboard.html">← Volver al Panel</a>
            <a href="index.html">Inicio</a>
            <a id="accountLink" href="account.html">Cuenta</a>
        </nav>
    </header>

    <div class="container" style="max-width: 1200px;">
        <h1 id="pageTitle" style="color:#2c5db5; font-size:36px; margin-bottom:24px;">Editar Usuario</h1>

        <div id="mainLayout" style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
            <!-- Formulario -->
            <div class="card">
                <h2 style="color:#2c5db5; margin-top:0;">Datos del Usuario</h2>

                <form id="userForm">
                    <input type="hidden" id="userId" name="id_usuario">

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nombre">Nombre *</label>
                            <input type="text" id="nombre" name="nombre" required>
                        </div>

                        <div class="form-group">
                            <label for="apellido">Apellido *</label>
                            <input type="text" id="apellido" name="apellido" required>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" required>
                        </div>

                        <div class="form-group">
                            <label for="telefono">Teléfono</label>
                            <input type="tel" id="telefono" name="telefono">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="curp">CURP</label>
                            <input type="text" id="curp" name="curp" maxlength="18">
                        </div>

                        <div class="form-group">
                            <label for="fecha_nacimiento">Fecha de Nacimiento</label>
                            <input type="date" id="fecha_nacimiento" name="fecha_nacimiento">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="direccion">Dirección</label>
                        <input type="text" id="direccion" name="direccion">
                    </div>

                    <div class="form-group">
                        <label for="rol">Rol *</label>
                        <select id="rol" name="rol" required>
                            <option value="operador">Operador</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>

                    <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">

                    <h3 id="passwordSectionTitle" style="color:#2c5db5; margin-bottom:16px;">Cambiar Contraseña
                        (Opcional)</h3>
                    <p id="passwordSectionDesc" style="color:#64748b; font-size:14px; margin-bottom:16px;">Deja este
                        campo vacío si no deseas cambiar la contraseña.</p>

                    <div class="form-group">
                        <label for="nueva_password"><span id="passwordLabel">Nueva Contraseña</span> <span
                                id="passwordRequired" style="display:none; color:#d00000;">*</span></label>
                        <input type="password" id="nueva_password" name="nueva_password" minlength="6">
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn outline" onclick="window.history.back()">Cancelar</button>
                        <button type="submit" class="btn primary">Actualizar Usuario</button>
                    </div>
                </form>

                <p id="msg" style="margin-top:16px; font-weight:600;"></p>
            </div>

            <!-- Info y Historial (solo para edición) -->
            <div id="sidebarInfo">
                <div class="card" style="margin-bottom:16px;">
                    <h3 style="color:#2c5db5; margin-top:0;">Información</h3>
                    <p style="margin:8px 0;"><strong>Fecha de ingreso:</strong> <span id="fechaRegistro">-</span></p>
                    <p style="margin:8px 0;"><strong>Última modificación:</strong> <span id="fechaModificacion">-</span>
                    </p>

                    <div style="margin-top:16px;">
                        <button class="btn outline" style="width:100%; margin-bottom:8px;"
                            onclick="verHistorialCompleto()">Ver Historial Completo</button>
                        <button class="btn outline" style="width:100%;" onclick="verRegistroCompleto()">Ver Registro
                            de Actividad</button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="color:#2c5db5; margin-top:0;">Últimos Cambios</h3>
                    <div id="historialReciente" style="max-height:300px; overflow-y:auto;">
                        <p style="color:#64748b; text-align:center;">Cargando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/header.js"></script>
    <script>
        let userId = null;
        let isEdit = false;
        let fromTab = 'productos'; // Valor por defecto

        (async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            userId = urlParams.get('id');
            isEdit = !!userId;

            // Leer el parámetro 'from_tab' para saber a dónde volver
            const tabParam = urlParams.get('from_tab');
            if (tabParam) {
                fromTab = tabParam;
            }

            // Actualizar el enlace de "Volver al Panel"
            const backLink = document.querySelector('a[href="admin-dashboard.html"]');
            if (backLink) {
                backLink.href = `admin-dashboard.html#${fromTab}`;
            }


            if (isEdit) {
                // Modo edición
                document.getElementById('pageTitle').textContent = 'Editar Usuario';
                await loadUser(userId);
                await loadHistorialReciente(userId);
            } else {
                // Modo creación
                document.getElementById('pageTitle').textContent = 'Registrar Usuario';

                // Cambiar layout a una sola columna
                document.getElementById('mainLayout').style.gridTemplateColumns = '1fr';

                // Ocultar sidebar de información/historial
                document.getElementById('sidebarInfo').style.display = 'none';

                // Cambiar texto de contraseña a requerida
                document.getElementById('passwordSectionTitle').textContent = 'Contraseña';
                document.getElementById('passwordSectionDesc').textContent = 'La contraseña es obligatoria al crear un nuevo usuario.';
                document.getElementById('passwordRequired').style.display = 'inline';
                document.getElementById('nueva_password').required = true;

                // Cambiar texto del botón a "Registrar"
                document.querySelector('#userForm button[type="submit"]').textContent = 'Registrar Usuario';
            }

            setupForm();
        })();

        async function loadUser(id) {
            try {
                const response = await fetch(`../api/admin_user_get.php?id=${id}`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Error al cargar usuario');

                const data = await response.json();
                const user = data.usuario;

                document.getElementById('userId').value = user.id_usuario;
                document.getElementById('nombre').value = user.nombre || '';
                document.getElementById('apellido').value = user.apellido || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('telefono').value = user.telefono || '';
                document.getElementById('curp').value = user.curp || '';
                document.getElementById('fecha_nacimiento').value = user.fecha_nacimiento || '';
                document.getElementById('direccion').value = user.direccion || '';
                document.getElementById('rol').value = user.rol || 'operador';

                // Fechas
                if (user.fecha_registro) {
                    const fecha = new Date(user.fecha_registro);
                    document.getElementById('fechaRegistro').textContent = fecha.toLocaleString('es-MX');
                }

                if (user.fecha_ultima_modificacion) {
                    const fecha = new Date(user.fecha_ultima_modificacion);
                    document.getElementById('fechaModificacion').textContent = fecha.toLocaleString('es-MX');
                } else {
                    document.getElementById('fechaModificacion').textContent = 'Sin modificaciones';
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar usuario');
            }
        }

        async function loadHistorialReciente(id) {
            try {
                const response = await fetch(`../api/admin_user_history.php?id=${id}`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Error al cargar historial');

                const data = await response.json();
                const historial = data.historial || [];

                const container = document.getElementById('historialReciente');

                if (historial.length === 0) {
                    container.innerHTML = '<p style="color:#64748b; text-align:center;">Sin cambios registrados</p>';
                    return;
                }

                container.innerHTML = '';

                // Mostrar solo los 5 más recientes
                historial.slice(0, 5).forEach(cambio => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '12px';
                    div.style.padding = '8px';
                    div.style.background = '#f8f9fa';
                    div.style.borderRadius = '6px';
                    div.style.fontSize = '13px';

                    const fecha = new Date(cambio.fecha_cambio);
                    const fechaStr = fecha.toLocaleString('es-MX', { dateStyle: 'short', timeStyle: 'short' });

                    div.innerHTML = `
                        <div style="font-weight:600; color:#2c5db5;">${cambio.campo_modificado}</div>
                        <div style="color:#64748b; margin:4px 0;">
                            <span style="text-decoration:line-through;">${cambio.valor_anterior || 'vacío'}</span>
                            → ${cambio.valor_nuevo || 'vacío'}
                        </div>
                        <div style="font-size:11px; color:#94a3b8;">
                            ${fechaStr} por ${cambio.modificador_nombre} ${cambio.modificador_apellido || ''}
                        </div>
                    `;

                    container.appendChild(div);
                });

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('historialReciente').innerHTML =
                    '<p style="color:#d00000; text-align:center;">Error al cargar historial</p>';
            }
        }

        function setupForm() {
            const form = document.getElementById('userForm');

            form.onsubmit = async (e) => {
                e.preventDefault();

                const msg = document.getElementById('msg');
                msg.textContent = '';

                try {
                    const formData = new FormData(form);

                    // Seleccionar el endpoint correcto según el modo
                    const endpoint = isEdit ? '../api/admin_user_update.php' : '../api/admin_user_create.php';
                    msg.textContent = isEdit ? 'Actualizando usuario...' : 'Creando usuario...';
                    msg.style.color = '#2c5db5';

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });

                    const text = await response.text();

                    if (response.ok && text === 'OK') {
                        msg.textContent = isEdit ? '✓ Usuario actualizado correctamente' : '✓ Usuario creado correctamente';
                        msg.style.color = '#2bb640';

                        if (isEdit) {
                            // Recargar datos en modo edición
                            await loadUser(userId);
                            await loadHistorialReciente(userId);
                        } else {
                            // Redirigir al dashboard después de crear, a la pestaña correcta
                            setTimeout(() => {
                                window.location.href = `admin-dashboard.html#${fromTab}`;
                            }, 1500);
                        }
                    } else {
                        msg.textContent = 'Error: ' + text;
                        msg.style.color = '#d00000';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    msg.textContent = 'Error de conexión';
                    msg.style.color = '#d00000';
                }
            };
        }

        function verHistorialCompleto() {
            window.location.href = `admin-user-history.html?id=${userId}`;
        }

        function verRegistroCompleto() {
            window.location.href = `admin-user-activity.html?id=${userId}`;
        }
    </script>
</body>

</html>